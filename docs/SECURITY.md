# AI Construction Platform — Security

## 1. Назначение документа

Этот документ описывает принципы безопасности AI Construction Platform.

Цель:
- защитить данные пользователей и компаний;
- обеспечить изоляцию tenant’ов;
- предотвратить утечки ключей и секретов;
- зафиксировать правила аутентификации и авторизации;
- обеспечить аудит и воспроизводимость действий.

Безопасность рассматривается как часть архитектуры, а не как надстройка.

---

## 2. Основные принципы безопасности

1. Principle of Least Privilege — доступ только к необходимому.
2. Tenant Isolation — строгая изоляция данных между компаниями.
3. No Secrets in Repo — никаких ключей и паролей в репозитории.
4. Deterministic Core — безопасность не влияет на расчётную логику.
5. Auditability — все значимые действия логируются.

---

## 3. Tenant Isolation

Каждый tenant представляет отдельную логическую зону безопасности.

Правила:
- все запросы выполняются в контексте tenant;
- идентификаторы данных уникальны внутри tenant;
- доступ к данным другого tenant невозможен.

Нарушение tenant isolation считается критической ошибкой.

---

## 4. Аутентификация

### 4.1 API Key (MVP)

Используется для:
- сервер-сервер запросов;
- внутренних сервисов;
- тестовых интеграций.

Правила:
- API Key передаётся только через заголовок;
- ключи имеют статус (active / revoked);
- ключи хранятся в зашифрованном виде.

---

### 4.2 JWT (пользовательская аутентификация)

JWT используется для:
- пользовательских сессий;
- UI-доступа;
- B2B сценариев.

JWT содержит:
- user_id
- tenant_id
- roles
- срок действия

JWT не содержит бизнес-данных.

---

## 5. Авторизация (RBAC)

Используется Role-Based Access Control.

### 5.1 Примеры ролей
- owner — полный доступ
- admin — управление пользователями
- engineer — ввод и изменение данных
- viewer — просмотр результатов

### 5.2 Правила
- роли проверяются на каждом запросе;
- роли не влияют на расчётную логику;
- отсутствие прав возвращает явную ошибку.

---

## 6. Управление секретами

Секреты включают:
- API Keys
- JWT secrets
- database credentials
- external service tokens

Правила:
- секреты хранятся только в environment variables;
- `.env` файлы не коммитятся;
- секреты не логируются;
- доступ к секретам ограничен сервисами.

---

## 7. Безопасность импорта

Импортируемые файлы считаются недоверенными.

Меры:
- проверка типа и размера файла;
- изоляция среды обработки;
- отсутствие выполнения кода;
- обязательное подтверждение данных пользователем.

Импорт не может:
- изменить CalculationProfile;
- обойти правила ядра;
- создать результат без подтверждения.

---

## 8. Безопасность расчётного ядра

Расчётное ядро:
- не зависит от UI;
- не принимает свободный текст;
- работает только со структурированными данными;
- не использует внешние сервисы во время расчёта.

Любая попытка обойти ядро считается нарушением архитектуры.

---

## 9. Логирование и аудит

Логируются:
- входы в систему;
- изменения входных данных;
- запуск расчёта;
- создание версий;
- ошибки и блокировки.

Логи:
- не содержат секретов;
- привязаны к tenant и пользователю;
- используются для аудита и расследований.

---

## 10. Версионирование и безопасность

Любое изменение, влияющее на результат:
- создаёт новую версию;
- сохраняет предыдущую;
- доступно для аудита.

Удаление истории версий запрещено.

---

## 11. Защита от ошибок пользователя

Платформа:
- явно сообщает о блокировках;
- не выполняет частичных расчётов;
- не скрывает ошибки.

Безопасность включает защиту от некорректных действий пользователя.

---

## 12. Защита от злоупотреблений

Меры:
- rate limiting;
- ограничение размера запросов;
- защита от повторных запросов;
- контроль количества расчётов.

---

## 13. Чего система делать НЕ МОЖЕТ

Запрещено:
- выполнять расчёты без аутентификации;
- обращаться к данным другого tenant;
- хранить секреты в коде;
- скрывать ошибки безопасности;
- выполнять логику в UI или LLM.

---

## 14. Эволюция безопасности

Допускается:
- добавление новых методов аутентификации;
- усиление RBAC;
- интеграция с корпоративными IAM.

Недопустимо:
- ослабление tenant isolation;
- отказ от аудита;
- компромиссы в пользу UX.

---

## 15. Статус документа

Этот документ:
- обязателен для всех компонентов платформы;
- используется как база для security review;
- изменяется редко и контролируемо.
