# AI Construction Platform — Engine Specification

## 1. Назначение документа

Документ описывает строгий контракт расчётного ядра (Core Engine) платформы.

Цель документа:
- зафиксировать правила работы расчётного движка;
- обеспечить детерминированность и воспроизводимость результатов;
- исключить влияние интерфейса и LLM на расчёты;
- определить формат входа, выхода и ошибок.

Любая реализация, нарушающая данный контракт, считается некорректной.

---

## 2. Главный принцип

Ядро детерминировано. Интерфейс не влияет на расчёт.

Следствия:
- одинаковый вход всегда даёт одинаковый результат;
- результат не зависит от формулировки текста;
- результат не зависит от пользователя, времени и окружения;
- LLM и UI не участвуют в вычислениях.

---

## 3. Вход ядра (Engine Input)

Ядро принимает исключительно структурированные данные.

### 3.1 Project Profile
- region
- object_type
- customer_type (private / company / government)
- quality_level (economy / comfort / business / premium)
- constraints

### 3.2 Work Graph
- work_id (канонический)
- calculation_profile_id
- parameters (подтверждённые)
- dependencies

### 3.3 Engine Context
- версия правил
- версия справочников
- режим расчёта (draft / final)

---

## 4. CalculationProfile

CalculationProfile — центральная сущность расчётного ядра.

Содержит:
- profile_id
- work_id
- params
- formulas
- bom
- rules
- qc
- outputs

CalculationProfile является данными, а не кодом.

---

## 5. Params (входные параметры)

Пример параметра:

    key: wall_area
    type: number
    required: true
    min: 0
    max: 10000
    ui_hint: Площадь стен, м²

Правила:
- параметры валидируются до расчёта;
- отсутствие обязательного параметра останавливает расчёт;
- неподтверждённые значения не используются.

---

## 6. Formulas (расчёт объёмов)

Формулы описывают вычисление количественных значений.

Пример формулы:

    id: paint_volume
    expression: wall_area * layers * consumption_rate
    unit: liters

Правила:
- формулы не содержат UX-логики;
- коэффициенты заданы явно;
- формулы не используют внешние сервисы.

---

## 7. BOM (Bill of Materials / Tools / Equipment)

BOM формируется ядром.

Пример элемента BOM:

    resource_id: paint_interior
    resource_type: material
    unit: liters
    quantity_formula: paint_volume
    quality_classes: comfort, business, premium
    conditions: layers > 1

Правила:
- пользователь не может добавлять позиции вручную;
- условия включения детерминированы;
- BOM не зависит от UI.

---

## 8. Rule Engine

Rule Engine применяет правила до формирования результата.

Типы правил:
- inclusion — добавление ресурсов;
- validation — проверки;
- block — запреты;
- conditional — условия;
- escalation — действия при проблемах.

Пример правила:

    type: block
    condition: base_is_wet == true
    message: Нельзя выполнять покраску по влажному основанию

---

## 9. Quality Control (QC)

QC — обязательная часть результата.

Пример QC-пункта:

    stage: Подготовка поверхности
    check: Поверхность сухая и очищена от пыли
    severity: required

QC всегда возвращается в результате.

---

## 10. Выход ядра (Engine Result)

Результат имеет фиксированную структуру:

    project_profile
    inputs
    works
    materials
    tools
    equipment
    stages
    qc
    risks
    totals
    meta

Структура результата неизменна.

---

## 11. Версионирование

Новая версия создаётся при любом изменении:
- параметров;
- профилей;
- правил;
- справочников.

Нельзя исправить расчёт — можно только создать новую версию.

---

## 12. Ошибки и остановка расчёта

Расчёт останавливается, если:
- отсутствуют обязательные параметры;
- нарушены блокирующие правила;
- данные невалидны.

Ошибка возвращается структурировано.

---

## 13. Запреты

Запрещено:
- использовать свободный текст вместо ID;
- добавлять ресурсы вне BOM;
- считать в UI или LLM;
- изменять результат после расчёта;
- скрывать QC.

---

## 14. Расширяемость

Допускается:
- добавление CalculationProfile;
- добавление RulePack;
- расширение справочников.

Недопустимо:
- изменение контракта без версии;
- перенос логики в интерфейс;
- отказ от детерминизма.

---

## 15. Статус документа

Документ является обязательным контрактом между слоями платформы и изменяется редко.
