# AI Construction Platform — Domain Model

## 1. Назначение документа

Этот документ описывает **доменную модель платформы** — набор сущностей,
их ответственность, связи и **инварианты**, которые нельзя нарушать.

Цель:
- зафиксировать единый язык (ubiquitous language);
- исключить неоднозначности в коде, API и расчётах;
- обеспечить корректное версионирование и аудит;
- позволить масштабировать систему без переписывания логики.

Если реализация противоречит этому документу — реализация считается неверной.

---

## 2. Базовые принципы доменной модели

1. **Данные важнее текста** — система оперирует структурами и ID.
2. **Неизменяемость через версии** — изменения создают новую версию.
3. **Tenant isolation** — данные разных компаний изолированы.
4. **Детерминизм** — одинаковый ввод даёт одинаковый результат.
5. **Ядро не знает про UX** — доменная модель независима от интерфейса.

---

## 3. Tenant

### Назначение
`Tenant` — логическая граница компании/аккаунта.

### Роль
- изоляция данных;
- единый контекст для проектов, расчётов и пользователей;
- основа для B2B/B2G сценариев.

### Инварианты
- любой доступ к данным происходит **в контексте tenant**;
- данные разных tenant’ов не пересекаются;
- идентификаторы сущностей уникальны **внутри tenant**.

---

## 4. Project

### Назначение
`Project` — контейнер всего, что относится к одному объекту строительства/ремонта.

### Основные свойства
- `project_id`
- `tenant_id`
- `region`
- `object_type`
- `customer_type` (private / company / government)
- `quality_level` (economy / comfort / business / premium)
- `constraints` (ограничения объекта)
- `created_at`

### Роль
- задаёт **глобальный профиль** для всех расчётов;
- служит корнем для версий и работ.

### Инварианты
- Project **логически неизменяем**;
- любые изменения параметров проекта создают **новую версию расчёта**, а не “правку”.

---

## 5. Estimate и EstimateVersion

### Estimate
`Estimate` — корневой объект расчёта внутри проекта.

Свойства:
- `estimate_id`
- `project_id`
- `current_version_no`
- `created_at`

### EstimateVersion
`EstimateVersion` — **снимок состояния** расчёта.

Содержит:
- `estimate_id`
- `version_no`
- `input` (структурированные входные данные)
- `result` (структурированный результат ядра)
- `created_at`
- `created_by`

### Роль
- обеспечивает полную воспроизводимость;
- позволяет сравнивать версии;
- служит основой для аудита и споров.

### Инварианты
- версии **не изменяются**;
- новая версия создаётся при любом изменении:
  - входных параметров;
  - правил;
  - конфигураций профилей.

---

## 6. WorkUnit

### Назначение
`WorkUnit` — универсальный атом работы.

### Основные свойства
- `work_unit_id`
- `work_id` (канонический)
- `category` (demolition / construction / finishing и т.п.)
- `parameters` (значения, введённые пользователем)
- `dependencies` (другие WorkUnit)
- `calculation_profile_id`
- `status` (allowed / blocked / conditional)

### Роль
- связывает пользовательский ввод с расчётным профилем;
- используется для сборки плана работ.

### Инварианты
- WorkUnit не содержит логики расчёта;
- логика всегда находится в `CalculationProfile`.

---

## 7. CalculationProfile

### Назначение
`CalculationProfile` — **сердце предметной логики** платформы.

Это конфигурация, описывающая:
- какие параметры нужны;
- как считаются объёмы;
- какие ресурсы включаются;
- какие правила и запреты применяются;
- какие проверки качества выполняются.

### Состав
- `profile_id`
- `work_id`
- `params`
- `formulas`
- `bom`
- `rules`
- `qc`
- `outputs`

### Роль
- превращает входные данные в детерминированный результат;
- позволяет добавлять новые виды работ без изменения кода.

### Инварианты
- CalculationProfile является **данными**, а не кодом;
- одинаковый профиль + одинаковый ввод → одинаковый результат.

---

## 8. Rule Engine

### Назначение
`Rule Engine` — универсальный механизм применения правил.

### Типы правил
- `inclusion` — добавление ресурсов или условий;
- `validation` — проверки корректности;
- `block` — запреты выполнения работ;
- `conditional` — условные требования;
- `escalation` — действия при проблемах.

### Роль
- выявляет риски и ограничения;
- предотвращает некорректные расчёты.

### Инварианты
- правила применяются **до формирования результата**;
- нарушение блокирующего правила останавливает расчёт.

---

## 9. Resource

### Назначение
`Resource` — универсальная сущность для всего, что используется в работе.

### Типы
- material
- tool
- equipment

### Основные свойства
- `resource_id` (канонический)
- `type`
- `unit`
- `quality_classes`
- `compatibility_rules`

### Роль
- используется в BOM;
- участвует в расчётах и закупке.

### Инварианты
- ресурс выбирается по ID, не по тексту;
- качество ресурса ограничено профилем проекта.

---

## 10. Canonical Dictionary (логическая роль)

Хотя словарь хранится отдельно, доменная модель предполагает его наличие.

Словарь включает:
- работы (WorkLeaf);
- материалы;
- инструменты;
- этапы;
- чек-листы.

### Инварианты
- словарь — **single source of truth**;
- текст — слой представления, не логики.

---

## 11. Audit и воспроизводимость

Каждая версия расчёта должна позволять ответить:
- кто ввёл данные;
- какие параметры использовались;
- какие правила применились;
- почему результат получился именно таким.

Это обеспечивает:
- доверие пользователей;
- юридическую защиту;
- улучшение норм и правил.

---

## 12. Что запрещено доменной моделью

- хранить бизнес-логику в UI или контроллерах;
- изменять существующую версию расчёта;
- использовать свободный текст вместо канонических ID;
- смешивать импортированные данные с подтверждёнными.

---

## 13. Эволюция модели

Допустимые расширения:
- новые типы Resource;
- новые CalculationProfile;
- новые RulePack региона;
- новые статусы WorkUnit.

Недопустимые изменения:
- отказ от версионности;
- отказ от детерминизма;
- перенос логики из ядра в интерфейс.

---

## 14. Статус документа

Этот документ:
- является обязательным для разработки;
- изменяется редко;
- любые изменения требуют новой версии и пересмотра расчётов.

